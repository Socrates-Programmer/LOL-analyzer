{% extends "index.html" %}

{% block title %}
    analysis
{% endblock %}

{% block content %}
<div class="container mt-5">
<div class="row justify-content-center align-items-center text-center">
    <form action="" method="post" class="row justify-content-center">

        <!-- Equipo 1 -->
        <div class="col-md-5 col-12 mb-4">
            <h4 class="text-danger mb-4 fw-bold">Equipo 1</h4>
            {% for i in range(5) %}
            <div class="mb-3 text-start">
                <label for="team1-player-{{ i }}" class="form-label text-light fw-semibold">
                    Jugador {{ i + 1 }}
                </label>
                <select  id="team1-player-{{ i }}" class="form-select player-select mb-1" data-team="1" data-index="{{ i }}">
                    <option value="" selected>-- Seleccionar jugador --</option>
                    {% for invocador in invocadores %}
                    <option value="{{ invocador.summoner_name }}#{{ invocador.tagline }}">
                        {{ invocador.summoner_name }} ({{ invocador.tagline }})
                    </option>
                    {% endfor %}
                </select>
        <select 
        id="team1-role-{{ i }}" class="form-select form-select-sm role-select" data-team="1" data-index="{{ i }}">
            <option value="">-- Rol --</option>
            <option value="TOP">Top</option>
            <option value="JUNGLE">Jungla</option>
            <option value="MID">Mid</option>
            <option value="ADC">ADC</option>
            <option value="SUPPORT">Support</option>
        </select>

            </div>
            {% endfor %}
        </div>

        <!-- VS Centro -->

        <div class="col-md-2 col-12 d-flex flex-column align-items-center justify-content-center mb-4">
            <button type="button" class="btn btn-primary mb-3" id="comparar-btn">Comparar Equipos</button>
            <h1 class="fw-bold text-light mb-0">VS</h1>
            <button type="button" class="btn btn-primary mt-3" id="btnSortear">Sortear</button>
        </div>

        <!-- Equipo 2 -->
        <div class="col-md-5 col-12 mb-4">
            <h4 class="text-primary mb-4 fw-bold">Equipo 2</h4>
            {% for i in range(5) %}
            <div class="mb-3 text-start">
                <label for="team2-player-{{ i }}" class="form-label text-light fw-semibold">
                    Jugador {{ i + 6 }}
                </label>
                <select id="team2-player-{{ i }}" class="form-select player-select mb-1" data-team="2" data-index="{{ i }}">
                    <option value="" selected>-- Seleccionar jugador --</option>
                    {% for invocador in invocadores %}
                    <option value="{{ invocador.summoner_name }}#{{ invocador.tagline }}">
                        {{ invocador.summoner_name }} ({{ invocador.tagline }})
                    </option>
                    {% endfor %}
                </select>
        <select id="team2-role-{{ i }}" class="form-select form-select-sm role-select" data-team="2" data-index="{{ i }}">

            <option value="">-- Rol --</option>
            <option value="TOP">Top</option>
            <option value="JUNGLE">Jungla</option>
            <option value="MID">Mid</option>
            <option value="ADC">ADC</option>
            <option value="SUPPORT">Support</option>
        </select>

            </div>
            {% endfor %}
        </div>
    </form>
</div>
</div>

<!-- Contenedor que se mostrará dinámicamente al recibir datos -->
<div class="container mt-5 text-center" id="resultado-grafico" style="display: none;">
    <h5 class="text-light">Probabilidad de victoria por equipo:</h5>
    <h6 id="mensaje-equipo" class="fw-bold"></h6>
    <canvas id="victoryChart" style="max-width: 270px; margin: auto;"></canvas>
</div>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JS para dropdown y gráfica -->
<script>
// Evitar jugadores repetidos en selects
function actualizarOpciones() {
    const selects = document.querySelectorAll('.player-select');
    const seleccionados = Array.from(selects).map(s => s.value).filter(v => v !== "");

    selects.forEach(select => {
        const actual = select.value;
        Array.from(select.options).forEach(option => {
            if (option.value === "") {
                option.disabled = false;
                return;
            }
            option.disabled = (option.value !== actual && seleccionados.includes(option.value));
        });
    });

    // Evitar roles repetidos por equipo
    const roleSelects = document.querySelectorAll('.role-select');
    const equipos = {
        "1": [],
        "2": []
    };

    // Agrupar roles seleccionados por equipo
    roleSelects.forEach(select => {
        const team = select.dataset.team;
        const role = select.value;
        if (role !== "") {
            equipos[team].push(role);
        }
    });

    // Deshabilitar roles ya seleccionados por equipo (excepto el propio)
    roleSelects.forEach(select => {
        const team = select.dataset.team;
        const actual = select.value;

        Array.from(select.options).forEach(option => {
            if (option.value === "") {
                option.disabled = false;
                return;
            }

            // Deshabilitar si ya fue seleccionado por otro en el mismo equipo
            option.disabled = (
                option.value !== actual && equipos[team].includes(option.value)
            );
        });
    });
}

// Listeners
document.querySelectorAll('.player-select, .role-select').forEach(select => {
    select.addEventListener('change', actualizarOpciones);
});

// Inicialización
actualizarOpciones();




document.addEventListener("DOMContentLoaded", () => {

function sortearEquipos() {
    const playerSelects = document.querySelectorAll('.player-select');
    if (playerSelects.length === 0) {
    console.warn("No se encontraron selectores de jugadores");
    return;
    }
    
    const allPlayers = Array.from(playerSelects[0].options)
        .filter(opt => opt.value !== "")
        .map(opt => opt.value);

    // Mezclar jugadores
    for (let i = allPlayers.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allPlayers[i], allPlayers[j]] = [allPlayers[j], allPlayers[i]];
    }

    const selectedPlayers = allPlayers.slice(0, 10);

    // Asignar jugadores a equipos
    for (let i = 0; i < 5; i++) {
        const playerSelect1 = document.getElementById(`team1-player-${i}`);
        const playerSelect2 = document.getElementById(`team2-player-${i}`);
        if (playerSelect1) playerSelect1.value = selectedPlayers[i];
        if (playerSelect2) playerSelect2.value = selectedPlayers[i + 5];
    }

    // Roles únicos por equipo
    const roles = ["TOP", "JUNGLE", "MID", "ADC", "SUPPORT"];

    // Mezclar y asignar roles para cada equipo
    const shuffledRoles1 = [...roles].sort(() => Math.random() - 0.5);
    const shuffledRoles2 = [...roles].sort(() => Math.random() - 0.5);

    for (let i = 0; i < 5; i++) {
        const roleSelect1 = document.getElementById(`team1-role-${i}`);
        const roleSelect2 = document.getElementById(`team2-role-${i}`);
        if (roleSelect1) roleSelect1.value = shuffledRoles1[i];
        if (roleSelect2) roleSelect2.value = shuffledRoles2[i];
    }

    actualizarOpciones();
}

const btnSortear = document.getElementById('btnSortear');
if (btnSortear) {
btnSortear.addEventListener('click', () => {
    console.log("Botón sortear presionado");
    sortearEquipos();
});
} else {
console.warn("No se encontró el botón btnSortear");
}

});

document.getElementById('comparar-btn').addEventListener('click', async function () {
    const team1 = [];
    const team2 = [];
    const team1_roles = [];
    const team2_roles = [];

    for (let i = 0; i < 5; i++) {
        const p1 = document.getElementById(`team1-player-${i}`).value;
        const p2 = document.getElementById(`team2-player-${i}`).value;
        const r1 = document.getElementById(`team1-role-${i}`).value;
        const r2 = document.getElementById(`team2-role-${i}`).value;

        if (!p1 || !p2) {
            alert("Selecciona todos los jugadores.");
            return;
        }
        if (!r1 || !r2) {
            alert("Selecciona todos los roles.");
            return;
        }

        team1.push(p1);
        team2.push(p2);
        team1_roles.push(r1);
        team2_roles.push(r2);
    }

    try {
        const response = await fetch("/calcular_kda", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ team1, team2, team1_roles, team2_roles })
        });

        const data = await response.json();

        if (response.ok) {
            // Mostrar gráfico con las probabilidades recibidas
            mostrarResultado(data.equipo1_prob, data.equipo2_prob);
        } else if (data.error && data.jugadores) {
            alert(`${data.error}\n\nFaltan KDA para:\n- ${data.jugadores.join("\n- ")}`);
        } else {
            alert(data.error || "Error desconocido.");
        }
    } catch (error) {
        alert("Ocurrió un error al procesar la solicitud.");
        console.error(error);
    }
});

function mostrarResultado(prob1, prob2) {
    const contenedor = document.getElementById("resultado-grafico");
    const mensaje = document.getElementById("mensaje-equipo");

    let texto = "Empate";
    let color = "white";

    if (prob1 > prob2) {
        texto = "Equipo 1 (Rojo) es más probable que gane";
        color = "red";
    } else if (prob2 > prob1) {
        texto = "Equipo 2 (Azul) es más probable que gane";
        color = "blue";
    }

    mensaje.textContent = texto;
    mensaje.style.color = color;

    contenedor.style.display = "block";

    const ctx = document.getElementById("victoryChart").getContext("2d");

    // Destruir gráfico anterior si existe
    if (window.victoryChartInstance) {
        window.victoryChartInstance.destroy();
    }

    window.victoryChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [prob1, prob2],
                backgroundColor: ['#dc3545', '#0d6efd']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}


</script>
{% endblock %}
